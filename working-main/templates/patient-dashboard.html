<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoldenSage | My Health Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');

        :root {
            --primary: #5A7F61;
            --accent: #C5A028;
            --bg-body: #F8FAFC;
            --sidebar-bg: #FFFFFF;
            --patient-alt: #E8F0EA;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #E11D48;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            margin: 0;
            display: flex;
            background-color: var(--bg-body);
            height: 100vh;
            overflow: hidden;
            color: #1E293B;
        }

        /* --- SIDEBAR (Clean & White for Patients) --- */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            padding: 40px 20px;
            border-right: 1px solid #E2E8F0;
            display: flex;
            flex-direction: column;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px 20px;
            text-decoration: none;
            color: #64748B;
            border-radius: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }

        .nav-link.active {
            background: var(--patient-alt);
            color: var(--primary);
        }

        .nav-link i {
            font-size: 1.2rem;
        }




        /* --- Master Visibility Control --- */
        .view-content {
            display: none !important;
            /* Forces everything to stay hidden */
            visibility: hidden;
            height: 0;
            overflow: hidden;
        }

        .view-content.active {
            display: block !important;
            visibility: visible;
            height: auto;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Layout Stability --- */
        .main-wrapper {
            flex: 1;
            overflow-y: auto;
            height: 100vh;
            padding: 40px;
            box-sizing: border-box;
        }

        /* --- PATIENT HERO --- */
        .welcome-box {
            background: linear-gradient(135deg, var(--primary) 0%, #3d7a68 100%);
            color: white;
            padding: 40px;
            border-radius: 35px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- DAILY ACTION CARDS --- */
        .action-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 25px;
        }

        .card {
            background: white;
            border-radius: 28px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 800;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .todo-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px;
            border-radius: 20px;
            background: #F1F5F9;
            margin-bottom: 12px;
            border: 1px solid transparent;
            transition: 0.3s;
        }

        .todo-item.done {
            opacity: 0.6;
            background: #F8FAFC;
            text-decoration: line-through;
        }

        .todo-item:hover {
            border-color: var(--primary);
            transform: scale(1.01);
        }

        .check-btn {
            width: 30px;
            height: 30px;
            border-radius: 10px;
            border: 2px solid var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .check-btn.active {
            background: var(--primary);
        }

        /* --- VITALS STRIP --- */
        .vitals-strip {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .mini-vital {
            background: white;
            padding: 20px;
            border-radius: 20px;
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid #E2E8F0;
        }

        .icon-circle {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        /* --- DOCTOR LIST FOR PATIENT --- */
        .doc-mini-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 1px solid #F1F5F9;
            border-radius: 18px;
            margin-bottom: 10px;
        }

        .doc-profile-card {
            padding: 20px;
            border: 1px solid #F1F5F9;
            border-radius: 22px;
            margin-bottom: 15px;
            background: #fdfdfd;
            transition: 0.3s;
        }

        .doc-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .doc-avatar {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            background: #E8F0EA;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .doc-desc {
            font-size: 0.85rem;
            color: #64748B;
            line-height: 1.5;
            background: #F8FAFC;
            padding: 10px;
            border-radius: 12px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
        }

        /* --- MEDICINE & TASK LAYOUT FEATURES --- */

        /* Badge Styles for Status */
        .badge-green {
            background: #DCFCE7;
            color: #16A34A;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .badge-red {
            background: #FFE4E6;
            color: #E11D48;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        /* Medicine Card & Task Item Layouts */
        .task-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #F8FAFC;
            border-radius: 15px;
            margin-bottom: 10px;
            transition: 0.3s;
        }

        .task-item.done {
            opacity: 0.6;
        }

        .task-item.done .task-text {
            text-decoration: line-through;
        }

        .check-btn {
            width: 24px;
            height: 24px;
            border: 2px solid #CBD5E1;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

        .check-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Medicine List Specific Styling */
        .med-card {
            background: white;
            padding: 20px;
            border-radius: 20px;
            border: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Timeline layout for medication history */
        .timeline-item {
            padding: 15px;
            border-left: 2px solid #E2E8F0;
            margin-left: 10px;
            position: relative;
            cursor: pointer;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -7px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--primary);
        }

        /* Medicine Modal/Popup Styles */
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        #modalIconContainer {
            width: 70px;
            height: 70px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 20px;
        }

        /* Badge Styles for Status */
        .badge-green {
            background: #DCFCE7;
            color: #16A34A;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .badge-red {
            background: #FFE4E6;
            color: #E11D48;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        /* Medicine Card Specific Styling */
        .med-card {
            background: white;
            padding: 20px;
            border-radius: 20px;
            border: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Modal Internal Icon Container */
        #modalIconContainer {
            width: 70px;
            height: 70px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 20px;
        }


        /* --- --------------------------------PROFILE LAYOUT --- ---------------------------------------*/
        .profile-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            align-items: start;
        }

        /* --- INFORMATION STYLING --- */
        .info-label {
            color: #64748B;
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 5px;
        }

        /* --- EMERGENCY CARD & ALERTS --- */
        .emergency-card {
            background: #0F172A;
            color: white;
            border-radius: 24px;
            padding: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 30px;
        }

        .warning-icon {
            width: 60px;
            height: 60px;
            background: #E11D48;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .badge-red {
            background: #FFE4E6;
            color: #E11D48;
            padding: 6px 16px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .badge-green {
            background: #F0FDF4;
            color: #16A34A;
            padding: 6px 16px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        /* --- EXPORT MEDICAL ID (PRINT LOGIC) --- */
        @media print {

            /* Hide the sidebar and other navigation during export */
            body * {
                visibility: hidden;
            }

            /* Show ONLY the Profile section */
            #p-profile,
            #p-profile * {
                visibility: visible !important;
            }

            #p-profile {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            /* Force background colors to show in PDF/Print */
            .emergency-card {
                background-color: #0F172A !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                color: white !important;
            }

            /* Hide buttons in the print version */
            button {
                display: none !important;
            }
        }

        /* --- TOP DASHBOARD STYLES --- */
        .top-dashboard {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: #6B7EB0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            border-bottom: 1px solid #E2E8F0;
            z-index: 1000;
            /* Keeps it above everything */
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-circle {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .brand-name {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            letter-spacing: -0.5px;
        }

        .header-right .home-ref {
            text-decoration: none;
            color: #CCD4E6;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .header-right .home-ref:hover {
            background: var(--bg-body);
            color: var(--primary);
        }

        /* --- ADJUSTING EXISTING LAYOUT --- */
        /* Push the sidebar and main content down 70px so they don't hide under the header */
        .sidebar {
            margin-top: 70px;
            height: calc(100vh - 70px) !important;
        }

        .main-wrapper {
            margin-top: 70px;
            height: calc(100vh - 70px) !important;
        }

        .help-card {
            background: var(--patient-alt);
            padding: 20px;
            margin: 20px;
            /* Reduced from a larger margin to move it up */
            border-radius: 20px;
            position: relative;
            bottom: 20px;
            /* You can adjust this value to pull it higher */
        }

        /* OR if your sidebar uses flexbox to push it down */
        .sidebar {
            display: flex;
            flex-direction: column;
        }

        .sidebar-footer {
            margin-top: auto;
            /* This pushes the button to the bottom */
            margin-bottom: 40px;
            /* Increase this to move the button FURTHER UP from the floor */
        }

        /* --- SOS EMERGENCY BUTTON --- */
        .sos-button {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #E11D48 0%, #BE123C 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1.8rem;
            font-weight: 900;
            cursor: pointer;
            margin-top: auto;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(225, 29, 72, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .sos-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(225, 29, 72, 0.5);
            background: linear-gradient(135deg, #BE123C 0%, #9D0E31 100%);
        }

        .sos-button:active {
            transform: scale(0.98);
        }

        .sos-pulse {
            animation: sos-pulse 2s infinite;
        }

        @keyframes sos-pulse {
            0% {
                box-shadow: 0 4px 15px rgba(225, 29, 72, 0.3);
            }
            50% {
                box-shadow: 0 8px 30px rgba(225, 29, 72, 0.6);
            }
            100% {
                box-shadow: 0 4px 15px rgba(225, 29, 72, 0.3);
            }
        }

        .sos-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .sos-modal.active {
            display: flex;
        }

        .sos-modal-content {
            background: white;
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: sos-slide-in 0.3s ease;
        }

        @keyframes sos-slide-in {
            from {
                transform: scale(0.8) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .sos-modal-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: sos-icon-shake 0.5s ease;
        }

        @keyframes sos-icon-shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .sos-modal-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: #E11D48;
            margin-bottom: 10px;
        }

        .sos-modal-text {
            font-size: 0.95rem;
            color: #64748B;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .sos-modal-buttons {
            display: flex;
            gap: 12px;
        }

        .sos-modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.95rem;
            transition: 0.3s;
        }

        .sos-modal-btn.confirm {
            background: #E11D48;
            color: white;
        }

        .sos-modal-btn.confirm:hover {
            background: #BE123C;
        }

        .sos-modal-btn.cancel {
            background: #F1F5F9;
            color: #64748B;
        }

        .sos-modal-btn.cancel:hover {
            background: #E2E8F0;
        }

        .sos-status {
            font-size: 0.85rem;
            color: #10B981;
            margin-top: 15px;
            display: none;
        }

        .sos-status.active {
            display: block;
        }

        /* --- Medication Reminder: Alarm Banner, Layout, and Time Picker --- */

        .alarm-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10000;
            background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%);
            color: white;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(255, 71, 87, 0.5);
            animation: alarmPulse 1s ease-in-out infinite;
            border-bottom: 5px solid #ff3838;
        }

        .alarm-banner.hidden {
            display: none;
        }

        @keyframes alarmPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 10px 40px rgba(255, 71, 87, 0.5);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 15px 50px rgba(255, 71, 87, 0.8);
            }
        }

        @keyframes alarmFlash {
            0%, 100% {
                background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%);
            }
            50% {
                background: linear-gradient(135deg, #ff6348 0%, #ff4757 100%);
            }
        }

        .alarm-banner.flashing {
            animation: alarmFlash 0.5s ease-in-out infinite, alarmPulse 1s ease-in-out infinite;
        }

        .alarm-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .alarm-icon {
            font-size: 3.2rem;
            animation: bellRing 0.5s ease-in-out infinite;
        }

        @keyframes bellRing {
            0%, 100% {
                transform: rotate(0deg);
            }
            25% {
                transform: rotate(-15deg);
            }
            75% {
                transform: rotate(15deg);
            }
        }

        .alarm-text {
            flex: 1;
            min-width: 260px;
        }

        .alarm-title {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 8px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.25);
        }

        .alarm-message {
            font-size: 1rem;
            line-height: 1.5;
        }

        .alarm-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .alarm-dismiss-btn,
        .alarm-snooze-btn {
            padding: 12px 18px;
            font-size: 0.95rem;
            font-weight: 700;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
            min-width: 160px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .alarm-dismiss-btn {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .alarm-dismiss-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(34, 197, 94, 0.6);
        }

        .alarm-snooze-btn {
            background: linear-gradient(135deg, var(--accent) 0%, #eab308 100%);
            color: #0f172a;
        }

        .alarm-snooze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(234, 179, 8, 0.6);
        }

        body.alarm-active .med-reminder-container {
            margin-top: 140px;
            transition: margin-top 0.3s ease;
        }

        @media (max-width: 768px) {
            .alarm-banner {
                padding: 18px;
            }

            .alarm-content {
                flex-direction: column;
                text-align: center;
            }

            .alarm-icon {
                font-size: 2.4rem;
            }

            .alarm-title {
                font-size: 1.3rem;
            }

            .alarm-message {
                font-size: 0.95rem;
            }

            .alarm-actions {
                width: 100%;
                flex-direction: column;
            }

            .alarm-dismiss-btn,
            .alarm-snooze-btn {
                width: 100%;
            }
        }

        .med-reminder-container {
            width: 100%;
            max-width: none;
            margin: 32px 0 0 0;
            background: #ffffff;
            border-radius: 28px;
            padding: 24px 26px 26px 26px;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.16);
            border: 1px solid #e2e8f0;
        }

        /* Keep layout tight and avoid overflow inside reminder */
        .med-reminder-container * {
            box-sizing: border-box;
        }

        .med-reminder-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 18px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .med-reminder-header-main {
            flex: 1;
        }

        .med-reminder-header h2 {
            font-size: 1.5rem;
            color: var(--primary);
            margin: 0 0 4px 0;
        }

        .med-reminder-header p {
            font-size: 0.9rem;
            color: #64748b;
            margin: 0;
        }

        .med-reminder-badge {
            padding: 6px 12px;
            border-radius: 999px;
            background: #ecfdf3;
            color: #15803d;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            white-space: nowrap;
        }

        .med-reminder-grid {
            display: grid;
            grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
            gap: 22px;
            align-items: flex-start;
        }

        /* Scrollable column for long medicine lists */
        .med-reminder-lists {
            max-height: 420px;
            overflow-y: auto;
            padding-right: 4px;
            scroll-behavior: smooth;
        }

        .med-reminder-lists::-webkit-scrollbar {
            width: 6px;
        }

        .med-reminder-lists::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 999px;
        }

        .med-reminder-lists::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 999px;
        }

        @media (max-width: 1200px) {
            .med-reminder-container {
                margin-top: 24px;
                padding: 20px 18px 22px 18px;
                border-radius: 22px;
            }

            .med-reminder-grid {
                grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
                gap: 18px;
            }

            .med-reminder-header h2 {
                font-size: 1.35rem;
            }

            .med-reminder-header p {
                font-size: 0.85rem;
            }
        }

        /* On very large screens, gently cap width so it stays readable */
        @media (min-width: 1400px) {
            .med-reminder-container {
                max-width: 1200px;
                margin-left: auto;
                margin-right: auto;
            }
        }

        @media (max-width: 900px) {
            .med-reminder-container {
                margin-top: 20px;
                padding: 18px 14px 20px 14px;
                border-radius: 20px;
            }

            .med-reminder-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .med-reminder-lists {
                max-height: none;
                overflow-y: visible;
            }

            .med-reminder-header {
                flex-direction: column;
                gap: 8px;
            }

            .med-reminder-header h2 {
                font-size: 1.25rem;
            }
        }

        @media (max-width: 600px) {
            .med-reminder-container {
                margin-top: 16px;
                padding: 14px 12px 18px 12px;
                border-radius: 18px;
            }

            .med-reminder-header h2 {
                font-size: 1.15rem;
            }

            .med-reminder-header p {
                font-size: 0.8rem;
            }
        }

        .med-reminder-card {
            background: #f8fafc;
            border-radius: 18px;
            padding: 18px;
            border: 1px solid #e2e8f0;
        }

        .med-reminder-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 6px;
        }

        .med-reminder-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 0.95rem;
            border-radius: 12px;
            border: 1px solid #cbd5f1;
        }

        .med-reminder-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(90, 127, 97, 0.25);
        }

        .med-time-strip {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            font-size: 0.85rem;
            color: #64748b;
        }

        .med-section {
            background: #ffffff;
            border-radius: 16px;
            padding: 14px;
            margin-bottom: 14px;
            border-left: 4px solid #cbd5f1;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.04);
        }

        .med-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .med-section-header h3 {
            font-size: 1rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #0f172a;
        }

        .med-add-btn {
            border: none;
            border-radius: 999px;
            padding: 8px 14px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            background: linear-gradient(135deg, var(--primary) 0%, #3b5a44 100%);
            color: #f9fafb;
        }

        .med-add-btn:hover {
            filter: brightness(1.05);
        }

        .med-item {
            background: #f9fafb;
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #e5e7eb;
            transition: box-shadow 0.2s ease, transform 0.1s ease;
        }

        .med-item:hover {
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
            transform: translateY(-1px);
        }

        .med-item.taken {
            background: #ecfdf3;
            border-color: #22c55e;
        }

        .med-item.next-dose {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(197, 160, 40, 0.45);
        }

        .med-item-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .med-item-row label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #64748b;
            min-width: 70px;
        }

        .med-item-row input[type="text"] {
            flex: 1;
            min-width: 160px;
            padding: 8px 10px;
            font-size: 0.9rem;
            border-radius: 10px;
            border: 1px solid #d1d5db;
        }

        .med-item-row input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        .time-input-btn {
            width: 100%;
            padding: 9px 12px;
            font-size: 0.95rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: #f9fafb;
            border: 1px solid var(--primary);
            border-radius: 999px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 3px 10px rgba(90, 127, 97, 0.45);
        }

        .time-input-btn .time-display-text {
            font-variant-numeric: tabular-nums;
        }

        .time-input-btn:hover {
            filter: brightness(1.05);
        }

        .taken-checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
            padding: 8px 10px;
            background: #f1f5f9;
            border-radius: 12px;
        }

        .taken-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #22c55e;
        }

        .taken-checkbox-container label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #0f172a;
        }

        .delete-btn {
            margin-top: 8px;
            background: #fee2e2;
            color: #b91c1c;
            border: none;
            padding: 7px 11px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #fecaca;
        }

        .med-summary-card {
            background: linear-gradient(135deg, var(--primary) 0%, #3b5a44 35%, var(--accent) 100%);
            color: #f9fafb;
            padding: 18px;
            border-radius: 18px;
            margin-bottom: 16px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.4);
        }

        .med-summary-card h3 {
            margin: 0 0 12px 0;
            font-size: 1.1rem;
        }

        .med-summary-stats {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .med-summary-stat {
            flex: 1;
            min-width: 90px;
            text-align: center;
            background: rgba(15, 23, 42, 0.3);
            border-radius: 12px;
            padding: 10px;
        }

        .med-summary-number {
            display: block;
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .med-summary-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .med-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }

        .med-action-btn {
            flex: 1;
            min-width: 130px;
            padding: 10px 12px;
            font-size: 0.95rem;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 3px 10px rgba(15, 23, 42, 0.15);
        }

        .med-action-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #3b5a44 100%);
            color: #f9fafb;
        }

        .med-action-secondary {
            background: #0f172a;
            color: #e5e7eb;
        }

        .med-action-info {
            background: #fef3c7;
            color: #854d0e;
        }

        .med-instructions-card {
            background: #fef9c3;
            border-radius: 16px;
            padding: 14px;
            border: 1px solid #facc15;
            font-size: 0.9rem;
            color: #854d0e;
        }

        .med-instructions-card h4 {
            margin: 0 0 8px 0;
            font-size: 0.95rem;
        }

        .med-instructions-card ul {
            padding-left: 18px;
            margin: 0;
        }

        .med-instructions-card li {
            margin-bottom: 4px;
        }

        .save-confirmation,
        .delete-confirmation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 11000;
            padding: 18px 24px;
            border-radius: 16px;
            color: white;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.35);
            font-size: 0.95rem;
        }

        .save-confirmation.hidden,
        .delete-confirmation.hidden {
            display: none;
        }

        .save-confirmation {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
        }

        .delete-confirmation {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .confirmation-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .confirmation-icon {
            font-size: 1.6rem;
        }

        .time-picker-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10500;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 18px;
        }

        .time-picker-modal.hidden {
            display: none;
        }

        .time-picker-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.65);
            backdrop-filter: blur(4px);
        }

        .time-picker-container {
            position: relative;
            background: #0b1120;
            border-radius: 24px;
            padding: 22px;
            max-width: 560px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 30px 80px rgba(15, 23, 42, 0.7);
            color: #e5e7eb;
        }

        .time-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .time-picker-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .time-picker-close {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: none;
            background: #ef4444;
            color: white;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .time-display-wrapper {
            text-align: center;
            padding: 16px;
            border-radius: 18px;
            background: radial-gradient(circle at top, var(--primary), #0f172a);
            margin-bottom: 16px;
        }

        .time-display-large {
            font-size: 2.4rem;
            font-weight: 800;
            letter-spacing: 0.08em;
        }

        .time-display-12h {
            font-size: 0.95rem;
            opacity: 0.85;
        }

        .time-presets-section {
            margin-bottom: 18px;
        }

        .presets-label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .time-presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
        }

        .time-preset-btn {
            padding: 10px 8px;
            border-radius: 12px;
            border: 1px solid #1e293b;
            background: #020617;
            color: #e5e7eb;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .time-preset-btn:hover {
            border-color: var(--accent);
            background: #111827;
        }

        .time-selectors-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            justify-content: center;
            margin: 14px 0 18px 0;
        }

        .time-selector-section {
            flex: 1;
            min-width: 150px;
            background: #020617;
            border-radius: 18px;
            border: 1px solid #1f2937;
            padding: 14px;
        }

        .time-selector-label {
            display: block;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
        }

        .time-selector-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .time-value-display {
            background: radial-gradient(circle at top, var(--primary), #111827);
            padding: 10px 14px;
            border-radius: 18px;
            border: 1px solid var(--accent);
            min-width: 100px;
            text-align: center;
        }

        .time-value {
            font-size: 2.2rem;
            font-weight: 800;
        }

        .time-btn {
            width: 44px;
            height: 44px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: #e5e7eb;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.7);
        }

        .time-btn-up {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .time-btn-down {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
        }

        .time-quick-adjust {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
            justify-content: center;
        }

        .quick-adjust-btn {
            border-radius: 999px;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            padding: 6px 10px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .quick-adjust-btn:hover {
            border-color: var(--accent);
        }

        .time-picker-actions {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .time-picker-btn {
            flex: 1;
            border-radius: 999px;
            border: none;
            padding: 10px 12px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
        }

        .time-picker-cancel {
            background: #111827;
            color: #e5e7eb;
        }

        .time-picker-confirm {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #0f172a;
        }
    </style>
</head>

<body>

    <!-- Global medication alarm banner (shows above dashboard when a dose is due) -->
    <div id="alarmBanner" class="alarm-banner hidden">
        <div class="alarm-content">
            <div class="alarm-icon">ðŸ””</div>
            <div class="alarm-text">
                <h2 class="alarm-title">Medication Reminder</h2>
                <p class="alarm-message" id="alarmMessage"></p>
            </div>
            <div class="alarm-actions">
                <button class="alarm-dismiss-btn" onclick="dismissAlarm()">I've taken it</button>
                <button class="alarm-snooze-btn" onclick="snoozeAlarm()">Remind me in 5 minutes</button>
            </div>
        </div>
    </div>

    <header class="top-dashboard">
        <div class="header-left">
            <div class="logo-circle" style="background: transparent;">
                <img src="/assets/nl.jpg" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">
            </div>
            <div>
                <span class="brand-name">GoldenSage</span>
                <div style="font-size: 0.7rem; color: #CCD4E6; font-weight: 600; letter-spacing: 1px;">PATIENT PORTAL</div>
            </div>
        </div>
        <div class="header-right">
            <div style="color: #CCD4E6; font-weight: 600; margin-right: 15px; font-size: 0.9rem;">
                <i class="fa-solid fa-circle-user"></i> <span id="patientName">Patient</span>
            </div>
            <a href="/main" class="home-ref">
                <i class="fa-solid fa-house"></i>
                <span> Home</span>
            </a>
        </div>
    </header>

    <aside class="sidebar">

        <div class="nav-link active" onclick="switchTab('p-home', this)"><i class="fa-solid fa-house-user"></i> My Day
        </div>
        <div class="nav-link" onclick="switchTab('p-medicine', this)"><i class="fa-solid fa-pills"></i> Medicine</div>
        <div class="nav-link" onclick="switchTab('p-profile', this)"><i class="fa-solid fa-circle-user"></i> My Profile
        </div>

        <div class="nav-link" onclick="window.location.href='/voice-assistant'">
            <i class="fa-solid fa-microphone"></i> Voice Assistant
        </div>
        <div class="nav-link" onclick="window.location.href='/connection'">
            <i class="fa-solid fa-hubspot"></i> Connections
        </div>
        <div class="nav-link" onclick="handleLogout()" style="margin-top: 10px; color: #E11D48;"><i
                class="fa-solid fa-right-from-bracket"></i> Logout</div>
        
        <!-- SOS Emergency Button -->
        <button class="sos-button sos-pulse" onclick="triggerSOSConfirm()" title="Emergency SOS - Notifies your guardian immediately">
            <i class="fa-solid fa-alarm"></i> SOS EMERGENCY
        </button>
    </aside>

    <main class="main-wrapper">

        <div id="p-home" class="view-content active">
            <div class="welcome-box">
                <div>
                    <h1 style="margin: 0; font-size: 2.5rem;" id="welcomeMessage">Welcome to Your Health Portal</h1>
                    <p style="opacity: 0.9; font-size: 1.1rem; margin-top: 10px;" id="taskSummary">Loading your health data...</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 1.2rem; font-weight: 700;" id="currentDate"></div>
                    <div style="opacity: 0.8;" id="weatherInfo">Your health dashboard</div>
                </div>
            </div>

            <div class="vitals-strip" id="vitalsContainer">
                <!-- Vitals injected by JS -->
                <div class="mini-vital">
                    <div class="icon-circle" style="background: #FFE4E6; color: #E11D48;"><i class="fa-solid fa-heart-pulse"></i></div>
                    <div><small style="color: #64748B;">Heart Rate</small><br><strong>72 bpm</strong></div>
                </div>
                <div class="mini-vital">
                    <div class="icon-circle" style="background: #E0F2FE; color: #0284C7;"><i class="fa-solid fa-droplet"></i></div>
                    <div><small style="color: #64748B;">Blood Sugar</small><br><strong>110 mg/dL</strong></div>
                </div>
                <div class="mini-vital">
                    <div class="icon-circle" style="background: #F0FDF4; color: #16A34A;"><i class="fa-solid fa-shoe-prints"></i></div>
                    <div><small style="color: #64748B;">Steps</small><br><strong>2,450</strong></div>
                </div>
            </div>

            <div class="action-grid">
                <div class="card">
                    <div class="card-title"><i class="fa-solid fa-list-check" style="color: var(--primary);"></i> Today's Schedule</div>
                    <div id="tasksContainer">
                        <div class="todo-item">
                            <div>
                                <strong>Morning Medication</strong><br>
                                <small style="color: #64748B;">Lisinopril â€¢ 10mg after breakfast</small>
                            </div>
                            <div class="check-btn" onclick="toggleTask(this)"><i class="fa-solid fa-check"></i></div>
                        </div>
                        <div class="todo-item">
                            <div>
                                <strong>Physiotherapy Walk</strong><br>
                                <small style="color: #64748B;">15 mins light walking in the garden</small>
                            </div>
                            <div class="check-btn" onclick="toggleTask(this)"><i class="fa-solid fa-check"></i></div>
                        </div>
                        <div class="todo-item">
                            <div>
                                <strong>Hydration Goal</strong><br>
                                <small style="color: #64748B;">Drink 2 glasses of water</small>
                            </div>
                            <div class="check-btn" onclick="toggleTask(this)"><i class="fa-solid fa-check"></i></div>
                        </div>
                        <div class="todo-item">
                            <div>
                                <strong>Blood Pressure Check</strong><br>
                                <small style="color: #64748B;">Log reading before lunch</small>
                            </div>
                            <div class="check-btn" onclick="toggleTask(this)"><i class="fa-solid fa-check"></i></div>
                        </div>
                        <div class="todo-item">
                            <div>
                                <strong>Afternoon Vitamin</strong><br>
                                <small style="color: #64748B;">Vitamin D3 â€¢ During lunch</small>
                            </div>
                            <div class="check-btn" onclick="toggleTask(this)"><i class="fa-solid fa-check"></i></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fa-solid fa-user-shield" style="color: var(--accent);"></i> My
                        Care Team</div>

                    <div class="doc-profile-card">
                        <div class="doc-header">
                            <div class="doc-avatar"><i class="fa-solid fa-heart-pulse"></i></div>
                            <div><strong>Dr. Sarah Chen</strong><br><small
                                    style="color:var(--success)">Cardiologist</small></div>
                        </div>
                        <div class="doc-desc">
                            Specializes in geriatric heart health. She manages your hypertension and monitors your daily
                            heart rate logs.
                        </div>
                    </div>

                    <div class="doc-profile-card">
                        <div class="doc-header">
                            <div class="doc-avatar"><i class="fa-solid fa-person-walking"></i></div>
                            <div><strong>Dr. Elizabeth Sterling</strong><br><small
                                    style="color:var(--primary)">Physiotherapist</small></div>
                        </div>
                        <div class="doc-desc">
                            Focuses on your balance and mobility. She assigned your 10-minute morning stretching
                            routine.
                        </div>
                    </div>

                    <div class="doc-profile-card">
                        <div class="doc-header">
                            <div class="doc-avatar"><i class="fa-solid fa-apple-whole"></i></div>
                            <div><strong>Dr. Jonathan Hyde</strong><br><small style="color:#6366f1">Nutritionist</small>
                            </div>
                        </div>
                        <div class="doc-desc">
                            In charge of your low-sodium diet plan and ensures your vitamin levels are optimal for
                            energy.
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div id="p-medicine" class="view-content">

            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px;">
                <div>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                        <span
                            style="color: var(--primary); font-weight: 800; text-transform: uppercase; font-size: 0.8rem;">My
                            Cabinet</span>
                        <span
                            style="background: #DCFCE7; color: #16A34A; padding: 4px 12px; border-radius: 50px; font-size: 0.7rem; font-weight: 800; border: 1px solid #BBF7D0;">
                            <i class="fa-solid fa-check-circle"></i> 3 MEDICINES IN STOCK
                        </span>
                    </div>
                    <h2 style="margin: 0; font-size: 2.2rem; font-weight: 800;">Digital Pharmacy</h2>
                </div>
                <button
                    style="background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 14px; font-weight: 700; cursor: pointer;">
                    <i class="fa-solid fa-truck-medical"></i> Request All Refills
                </button>
            </div>

            <div id="upcomingReminderCard" class="card" style="margin-bottom: 30px; background: linear-gradient(135deg, var(--primary) 0%, #3b5a44 100%); color: white; border: none;">
                <div class="card-title" style="color: white;"><i class="fa-solid fa-bell" style="color: var(--accent);"></i> Upcoming Reminder</div>
                <div id="upcomingReminderContent" style="padding: 16px 0; font-size: 1.1rem;">
                    <p style="margin: 0; opacity: 0.95;">No upcoming doses. Add medicines in the Smart Medication Reminder below.</p>
                </div>
            </div>

            <!-- Medication Reminder widget (interactive scheduler) -->
            <div class="med-reminder-container">
                <div class="med-reminder-header">
                    <div class="med-reminder-header-main">
                        <h2>Smart Medication Reminder</h2>
                        <p>Plan your daily medicines, get gentle alerts, and track what youâ€™ve taken.</p>
                    </div>
                    <span class="med-reminder-badge">
                        Daily routine
                    </span>
                </div>

                <div class="med-reminder-card" style="margin-bottom: 14px;">
                    <label for="mrPatientName" class="med-reminder-label">Patient name (for reminders)</label>
                    <input id="mrPatientName" type="text" class="med-reminder-input" placeholder="Enter your name">
                    <div class="med-time-strip" style="margin-top: 8px;">
                        <span>Current time will be tracked automatically.</span>
                        <span id="currentTime" style="font-weight: 700;"></span>
                    </div>
                </div>

                <div class="med-reminder-grid">
                    <div class="med-reminder-lists">
                        <div class="med-section" style="border-left-color:#f59e0b;">
                            <div class="med-section-header">
                                <h3>ðŸŒ… Morning</h3>
                                <button class="med-add-btn med-add-morning" onclick="addMedication('morning')">Add medication</button>
                            </div>
                            <div id="morningList"></div>
                        </div>

                        <div class="med-section" style="border-left-color:#0ea5e9;">
                            <div class="med-section-header">
                                <h3>â˜€ï¸ Afternoon</h3>
                                <button class="med-add-btn med-add-afternoon" onclick="addMedication('afternoon')">Add medication</button>
                            </div>
                            <div id="afternoonList"></div>
                        </div>

                        <div class="med-section" style="border-left-color:#6366f1;">
                            <div class="med-section-header">
                                <h3>ðŸŒ™ Evening & Night</h3>
                                <button class="med-add-btn med-add-evening" onclick="addMedication('evening')">Add medication</button>
                            </div>
                            <div id="eveningList"></div>
                        </div>
                    </div>

                    <div>
                        <div class="med-summary-card">
                            <h3>Today's medication progress</h3>
                            <div class="med-summary-stats">
                                <div class="med-summary-stat">
                                    <span class="med-summary-number" id="totalMeds">0</span>
                                    <span class="med-summary-label">Total doses</span>
                                </div>
                                <div class="med-summary-stat">
                                    <span class="med-summary-number" id="takenMeds">0</span>
                                    <span class="med-summary-label">Taken</span>
                                </div>
                                <div class="med-summary-stat">
                                    <span class="med-summary-number" id="pendingMeds">0</span>
                                    <span class="med-summary-label">Pending</span>
                                </div>
                            </div>
                            <p id="nextDoseText" style="margin-top: 10px; font-size: 0.85rem; color: rgba(226,232,240,0.95);">
                                No medicines scheduled in your reminder.
                            </p>
                        </div>

                        <div class="med-actions">
                            <button class="med-action-btn med-action-primary" onclick="saveAllData()">
                                <i class="fa-solid fa-floppy-disk"></i> Save schedule
                            </button>
                            <button class="med-action-btn med-action-secondary" onclick="resetDailyCheckmarks()">
                                <i class="fa-solid fa-rotate-left"></i> New day reset
                            </button>
                            <button class="med-action-btn med-action-info" onclick="testReminder()">
                                <i class="fa-solid fa-bell"></i> Test reminder
                            </button>
                        </div>

                        <div class="med-instructions-card">
                            <h4>How this works</h4>
                            <ul>
                                <li>Add each medicine with its time, dosage, and notes.</li>
                                <li>We'll remind you at the exact time with a banner and sound.</li>
                                <li>Tick "I have taken this medication" after each dose.</li>
                                <li>Use "New day reset" every morning to start fresh.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reminder save/delete confirmations -->
            <div id="saveConfirmation" class="save-confirmation hidden">
                <div class="confirmation-content">
                    <span class="confirmation-icon">âœ…</span>
                    <span class="confirmation-text">Medication schedule saved.</span>
                </div>
            </div>

            <div id="deleteConfirmation" class="delete-confirmation hidden">
                <div class="confirmation-content">
                    <span class="confirmation-icon">ðŸ—‘ï¸</span>
                    <span class="confirmation-text">Medication removed.</span>
                </div>
            </div>

            <!-- Time picker modal for choosing dose times -->
            <div id="timePickerModal" class="time-picker-modal hidden">
                <div class="time-picker-overlay" onclick="closeTimePicker()"></div>
                <div class="time-picker-container">
                    <div class="time-picker-header">
                        <h3>Choose dose time</h3>
                        <button class="time-picker-close" onclick="closeTimePicker()">âœ•</button>
                    </div>
                    <div class="time-picker-content">
                        <div class="time-display-wrapper">
                            <div class="time-display-large" id="timeDisplayLarge">08:00</div>
                            <div class="time-display-12h" id="timeDisplay12h">8:00 AM</div>
                        </div>

                        <div class="time-presets-section">
                            <label class="presets-label">Quick selections</label>
                            <div class="time-presets">
                                <button class="time-preset-btn" onclick="setPresetTime('06:00')">
                                    <span class="preset-time">6:00</span>
                                    <span class="preset-period">AM</span>
                                </button>
                                <button class="time-preset-btn" onclick="setPresetTime('08:00')">
                                    <span class="preset-time">8:00</span>
                                    <span class="preset-period">AM</span>
                                </button>
                                <button class="time-preset-btn" onclick="setPresetTime('12:00')">
                                    <span class="preset-time">12:00</span>
                                    <span class="preset-period">PM</span>
                                </button>
                                <button class="time-preset-btn" onclick="setPresetTime('14:00')">
                                    <span class="preset-time">2:00</span>
                                    <span class="preset-period">PM</span>
                                </button>
                                <button class="time-preset-btn" onclick="setPresetTime('18:00')">
                                    <span class="preset-time">6:00</span>
                                    <span class="preset-period">PM</span>
                                </button>
                                <button class="time-preset-btn" onclick="setPresetTime('20:00')">
                                    <span class="preset-time">8:00</span>
                                    <span class="preset-period">PM</span>
                                </button>
                                <button class="time-preset-btn" onclick="setPresetTime('22:00')">
                                    <span class="preset-time">10:00</span>
                                    <span class="preset-period">PM</span>
                                </button>
                            </div>
                        </div>

                        <div class="time-selectors-wrapper">
                            <div class="time-selector-section">
                                <label class="time-selector-label">Hour</label>
                                <div class="time-selector-controls">
                                    <button class="time-btn time-btn-up" onclick="adjustTime('hour', 1)">
                                        <span class="btn-icon">â–²</span>
                                    </button>
                                    <div class="time-value-display">
                                        <span class="time-value" id="hourValue">08</span>
                                    </div>
                                    <button class="time-btn time-btn-down" onclick="adjustTime('hour', -1)">
                                        <span class="btn-icon">â–¼</span>
                                    </button>
                                </div>
                                <div class="time-quick-adjust">
                                    <button class="quick-adjust-btn" onclick="adjustTime('hour', -1)">-1</button>
                                    <button class="quick-adjust-btn" onclick="adjustTime('hour', 1)">+1</button>
                                </div>
                            </div>

                            <div class="time-selector-section">
                                <label class="time-selector-label">Minute</label>
                                <div class="time-selector-controls">
                                    <button class="time-btn time-btn-up" onclick="adjustTime('minute', 1)">
                                        <span class="btn-icon">â–²</span>
                                    </button>
                                    <div class="time-value-display">
                                        <span class="time-value" id="minuteValue">00</span>
                                    </div>
                                    <button class="time-btn time-btn-down" onclick="adjustTime('minute', -1)">
                                        <span class="btn-icon">â–¼</span>
                                    </button>
                                </div>
                                <div class="time-quick-adjust">
                                    <button class="quick-adjust-btn" onclick="adjustTime('minute', -5)">-5</button>
                                    <button class="quick-adjust-btn" onclick="adjustTime('minute', 5)">+5</button>
                                    <button class="quick-adjust-btn" onclick="adjustTime('minute', -15)">-15</button>
                                    <button class="quick-adjust-btn" onclick="adjustTime('minute', 15)">+15</button>
                                </div>
                            </div>
                        </div>

                        <div class="time-picker-actions">
                            <button class="time-picker-btn time-picker-cancel" onclick="closeTimePicker()">Cancel</button>
                            <button class="time-picker-btn time-picker-confirm" onclick="confirmTimeSelection()">Confirm</button>
                        </div>
                    </div>
                </div>
        </div>
    </div>

        <div id="medicineDetailsModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
            <div
                style="background: white; width: 90%; max-width: 450px; border-radius: 24px; padding: 30px; position: relative; box-shadow: 0 20px 40px rgba(0,0,0,0.2); text-align: center;">
                <button onclick="closeCustomModal()"
                    style="position: absolute; top: 20px; right: 20px; background: #f1f5f9; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; color: #64748b;">&times;</button>

                <div id="modalIconContainer"
                    style="width: 70px; height: 70px; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 2rem;">
                </div>

                <h2 id="modalTitle" style="margin: 0 0 10px 0; font-size: 1.5rem; color: #1e293b; font-weight: 800;">
                </h2>
                <p id="modalDescription" style="margin: 0 0 25px 0; color: #64748b; line-height: 1.6; font-size: 1rem;">
                </p>

                <button onclick="closeCustomModal()"
                    style="width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: 0.2s;">
                    I Understand
                </button>
            </div>
        </div>





        <div id="p-profile" class="view-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <span
                        style="color: var(--primary); font-weight: 800; text-transform: uppercase; font-size: 0.8rem;">Identity
                        & Medical Background</span>
                    <h2 style="margin: 5px 0 0 0; font-size: 2.2rem; font-weight: 800;">Patient Profile</h2>
                </div>
                <button onclick="exportMedicalID()"
                    style="background: white; border: 1px solid #E2E8F0; padding: 12px 24px; border-radius: 12px; font-weight: 700; cursor: pointer;">
                    <i class="fa-solid fa-file-export"></i> Export Medical ID
                </button>
            </div>

            <div class="profile-grid">
                <div class="card" style="text-align: center;">
                    <div
                        style="width: 120px; height: 120px; background: #F1F5F9; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #94A3B8; border: 4px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.05);">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <h2 style="margin: 0;">GRANDPA</h2>
                    <p style="color: #64748B; font-weight: 600;">Patient ID: #GS-88210</p>

                    <hr style="border: 0; border-top: 1px solid #F1F5F9; margin: 25px 0;">

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left;">
                        <div>
                            <div class="info-label">Age</div>
                            <div class="info-value">72 Years</div>
                        </div>
                        <div>
                            <div class="info-label">Blood Type</div>
                            <div class="info-value" style="color: #E11D48;">O+ Positive</div>
                        </div>
                        <div>
                            <div class="info-label">Height</div>
                            <div class="info-value">178cm</div>
                        </div>
                        <div>
                            <div class="info-label">Weight</div>
                            <div class="info-value">82kg</div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="card" style="margin-bottom: 25px;">
                        <div class="card-title" style="font-size: 1rem;"><i class="fa-solid fa-clipboard-list"
                                style="color: var(--primary);"></i> Medical Conditions</div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <span class="badge-red">Hypertension</span>
                            <span class="badge-red">Type 2 Diabetes</span>
                            <span class="badge-green">Stable Osteoarthritis</span>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                        <div class="card">
                            <div class="info-label">Primary Caregiver</div>
                            <div class="info-value" style="margin-bottom: 5px;">Sarah Willoughby (Daughter)</div>
                            <div style="color: var(--primary); font-weight: 700;"><i class="fa-solid fa-phone"></i> +1
                                (555) 0123-456</div>
                        </div>
                        <div class="card">
                            <div class="info-label">Preferred Hospital</div>
                            <div class="info-value" style="margin-bottom: 5px;">Saint Jude Medical Center</div>
                            <div style="color: #64748B; font-size: 0.9rem;"><i class="fa-solid fa-location-dot"></i>
                                Emergency Wing B</div>
                        </div>
                    </div>
                    <div class="card" style="margin-bottom: 25px;">
                        <div class="card-title" style="font-size: 1rem;"><i class="fa-solid fa-file-medical"
                                style="color: var(--primary);"></i> Recent Clinical Reports</div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem; text-align: left;">
                            <thead>
                                <tr style="border-bottom: 2px solid #F1F5F9; color: #64748B;">
                                    <th style="padding: 10px 5px;">Test Type</th>
                                    <th style="padding: 10px 5px;">Result</th>
                                    <th style="padding: 10px 5px;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid #F1F5F9;">
                                    <td style="padding: 12px 5px;">HbA1c (Diabetes)</td>
                                    <td style="padding: 12px 5px;"><strong>6.4%</strong></td>
                                    <td style="padding: 12px 5px;"><span class="badge-green"
                                            style="padding: 2px 8px; font-size: 0.7rem;">OPTIMAL</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid #F1F5F9;">
                                    <td style="padding: 12px 5px;">LDL Cholesterol</td>
                                    <td style="padding: 12px 5px;"><strong>98 mg/dL</strong></td>
                                    <td style="padding: 12px 5px;"><span class="badge-green"
                                            style="padding: 2px 8px; font-size: 0.7rem;">STABLE</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid #F1F5F9;">
                                    <td style="padding: 12px 5px;">Kidney Function (eGFR)</td>
                                    <td style="padding: 12px 5px;"><strong>72 mL/min</strong></td>
                                    <td style="padding: 12px 5px;"><span class="badge-red"
                                            style="padding: 2px 8px; font-size: 0.7rem; background:#FEF3C7; color:#92400E;">MONITOR</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="card" style="margin-bottom: 25px;">
                        <div class="card-title" style="font-size: 1rem;"><i class="fa-solid fa-pills"
                                style="color: var(--primary);"></i> Active Medication List</div>
                        <div id="medsContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="text-align:center; padding:20px; color:#64748B; grid-column: span 2;">Loading
                                medications...</div>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: 25px;">
                        <div class="card-title" style="font-size: 1rem;"><i class="fa-solid fa-clock-rotate-left"
                                style="color: var(--primary);"></i> Significant Medical History</div>
                        <div
                            style="border-left: 2px solid #E2E8F0; margin-left: 10px; padding-left: 20px; font-size: 0.9rem;">
                            <p><strong>June 2024:</strong> Knee Replacement Surgery (Left) - Successful Recovery.</p>
                            <p><strong>Nov 2023:</strong> Diagnosed with Type 2 Diabetes; managed via Metformin.</p>
                        </div>
                    </div>

                    <div class="emergency-card">
                        <div class="warning-icon">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0; color: #FDA4AF; font-size: 1.2rem;">Critical Allergy Warning</h3>
                            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.95rem; line-height: 1.4;">
                                Severely allergic to <strong>Penicillin</strong> and <strong>Shellfish</strong>.
                                Avoid contact in all medical procedures and dietary offerings.
                            </p>
                        </div>
                    </div>

                    <div
                        style="margin-top: 20px; text-align: center; color: #94A3B8; font-size: 0.75rem; font-weight: 600;">
                        <i class="fa-solid fa-shield-halved"></i> Verified Medical Record â€¢ Last Updated: Dec 28, 2025
                    </div>
                </div>

            </div>


    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Set current date
            const today = new Date();
            document.getElementById('currentDate').textContent = today.toLocaleDateString('en-US', 
                { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Fetch patient data
            fetchPatientInfo();
            fetchDashboardData();
            
            // Initialize SOS button with pulse animation
            const sosBtn = document.querySelector('.sos-button');
            if (sosBtn) {
                sosBtn.classList.add('sos-pulse');
                console.log("âœ… SOS button initialized and visible");
            } else {
                console.error("âŒ SOS button not found in DOM!");
            }

            // Handle hash from voice assistant redirect (e.g. #p-medicine)
            const hash = window.location.hash.replace('#', '');
            if (hash && ['p-home', 'p-medicine', 'p-profile'].includes(hash)) {
                const navEl = document.querySelector('.nav-link[onclick*="' + hash + '"]');
                if (navEl) switchTab(hash, navEl);
            }
        });

        function fetchPatientInfo() {
            fetch('/api/patient/info')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data && data.name) {
                        const firstName = data.name.split(' ')[0];
                        document.getElementById('patientName').textContent = firstName;
                        document.getElementById('welcomeMessage').textContent = `Good Day, ${firstName}! ðŸ‘‹`;
                        const mrName = document.getElementById('mrPatientName');
                        if (mrName) mrName.value = data.name;
                        console.log("âœ… Patient info loaded:", data.name);
                    }
                })
                .catch(err => {
                    console.error("âŒ Error loading patient info:", err);
                    document.getElementById('patientName').textContent = "Patient";
                });
        }

        function fetchDashboardData() {
            fetch('/api/patient/dashboard-data')
                .then(response => {
                    if (response.status === 401 || response.status === 403) {
                        console.warn("Unauthorized, redirecting to login...");
                        window.location.href = '/login/patient';
                        return null;
                    }
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (!data) return;
                    if (data.error) {
                        console.error("API error:", data.error);
                        return;
                    }
                    console.log("âœ… Dashboard data loaded:", data);
                    
                    renderVitals(data.vitals || []);
                    renderTasks(data.tasks || []);
                    renderMeds(data.medications || []);
                    
                    // Update task summary
                    const taskCount = (data.tasks || []).length;
                    const completedCount = (data.tasks || []).filter(t => t.is_completed).length;
                    const pendingTasks = taskCount - completedCount;
                    
                    if (pendingTasks > 0) {
                        document.getElementById('taskSummary').textContent = 
                            `You have ${pendingTasks} task${pendingTasks !== 1 ? 's' : ''} to complete today. Great progress! ðŸ’ª`;
                    } else if (taskCount > 0) {
                        document.getElementById('taskSummary').textContent = 'All tasks completed! You\'re doing amazing! ðŸŽ‰';
                    } else {
                        document.getElementById('taskSummary').textContent = 'No tasks for today. Stay healthy! âœ¨';
                    }
                })
                .catch(err => {
                    console.error("âŒ Error loading dashboard:", err);
                    // Show fallback message
                    document.getElementById('taskSummary').textContent = 'Unable to load health data. Please refresh the page.';
                });
        }

        function renderVitals(vitals) {
            const container = document.getElementById('vitalsContainer');
            if (!vitals || vitals.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:10px; width:100%;">No vitals recorded today.</div>';
                return;
            }

            container.innerHTML = vitals.map(v => `
                <div class="mini-vital">
                    <div class="icon-circle" style="background: #F0FDF4; color: var(--primary);">
                        <i class="fa-solid fa-heart-pulse"></i>
                    </div>
                    <div>
                        <small style="color: #64748B;">${v.type}</small><br>
                        <strong>${v.value} ${v.unit}</strong>
                    </div>
                </div>
            `).join('');
        }

        function renderTasks(tasks) {
            const container = document.getElementById('tasksContainer');
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px;">No tasks for today! ðŸŽ‰</div>';
                return;
            }

            container.innerHTML = tasks.map(t => `
                <div class="todo-item ${t.is_completed ? 'done' : ''}" id="task-${t._id}">
                    <div>
                        <strong>${t.title}</strong><br>
                        <small style="color: #64748B;">${t.description}</small>
                    </div>
                    <div class="check-btn ${t.is_completed ? 'active' : ''}" onclick="toggleTask('${t._id}', this)">
                        <i class="fa-solid fa-check"></i>
                    </div>
                </div>
            `).join('');
        }

        function renderMeds(meds) {
            const container = document.getElementById('medsContainer');
            if (!meds || meds.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:10px; grid-column:span 2;">No medications listed.</div>';
                return;
            }

            container.innerHTML = meds.map(m => `
                <div style="background: #F8FAFC; padding: 12px; border-radius: 12px; border-left: 4px solid var(--primary);">
                    <strong>${m.name}</strong><br>
                    <small>${m.dosage} â€¢ ${m.time_of_day}</small>
                </div>
            `).join('');

            // Seed the interactive reminder from backend meds on first load
            if (window.seedReminderFromBackend) {
                try {
                    window.seedReminderFromBackend(meds);
                } catch (e) {
                    console.warn('Unable to seed reminder from backend meds:', e);
                }
            }
        }


        function toggleTask(taskId, btn) {
            // Check if taskId is actually the button element (for inline onclick)
            if (typeof taskId !== 'string' || taskId.startsWith('task-')) {
                // Legacy: handle button element passed directly
                btn = taskId;
                btn.classList.toggle('active');
                const item = btn.parentElement.parentElement;
                item.classList.toggle('done');
                return;
            }

            // API-based task toggle
            const item = document.getElementById(`task-${taskId}`);
            if (!item) {
                console.error("Task not found:", taskId);
                return;
            }

            const btn_el = item.querySelector('.check-btn');
            const isCurrentlyComplete = item.classList.contains('done');
            const newStatus = !isCurrentlyComplete;

            // Optimistic UI update
            btn_el.classList.toggle('active');
            item.classList.toggle('done');

            // API call with correct payload
            fetch('/api/task/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    task_id: taskId,
                    is_completed: newStatus
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') {
                        // Revert if failed
                        btn_el.classList.toggle('active');
                        item.classList.toggle('done');
                        console.error("Failed to update task:", data);
                    }
                })
                .catch(error => {
                    // Revert on error
                    btn_el.classList.toggle('active');
                    item.classList.toggle('done');
                    console.error('Task toggle error:', error);
                });
        }

        function handleLogout() {
            if (confirm("Are you sure you want to log out of GoldenSage?")) {
                window.location.href = "/signout";
            }
        }

        // Tab Switching Logic
        function switchTab(id, el) {
            const target = document.getElementById(id);
            if (!target) return;
            document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            target.classList.add('active');
            if (el) el.classList.add('active');
        }

        function showInstructions(name, text) {
            const modal = document.getElementById('medicineDetailsModal');
            const iconContainer = document.getElementById('modalIconContainer');
            document.getElementById('modalTitle').innerText = name + " Instructions";
            document.getElementById('modalDescription').innerText = text;
            iconContainer.style.background = '#E8F0EA';
            iconContainer.style.color = 'var(--primary)';
            iconContainer.innerHTML = '<i class="fa-solid fa-circle-info"></i>';
            modal.style.display = 'flex';
        }

        function requestRefill(patientId, medicineName) {
            const modal = document.getElementById('medicineDetailsModal');
            const iconContainer = document.getElementById('modalIconContainer');
            document.getElementById('modalTitle').innerText = "Refill Requested";
            document.getElementById('modalDescription').innerText = "Your request for a " + medicineName + " refill has been sent to your guardian.";
            iconContainer.style.background = '#DCFCE7';
            iconContainer.style.color = '#16A34A';
            iconContainer.innerHTML = '<i class="fa-solid fa-truck-medical"></i>';
            modal.style.display = 'flex';
        }

        function closeCustomModal() {
            document.getElementById('medicineDetailsModal').style.display = 'none';
        }

        function exportMedicalID() {
            switchTab('p-profile', document.querySelector('[onclick*="p-profile"]'));
            window.print();
        }

        function checkTimelineStatus(medName, time, isTaken) {
            const modal = document.getElementById('medicineDetailsModal');
            const iconContainer = document.getElementById('modalIconContainer');
            document.getElementById('modalTitle').innerText = medName;
            document.getElementById('modalDescription').innerText = 
                isTaken ? `âœ… You've successfully taken ${medName} at ${time}` : 
                `â° Time to take ${medName}. Scheduled at ${time}`;
            iconContainer.style.background = isTaken ? '#DCFCE7' : '#FEF3C7';
            iconContainer.style.color = isTaken ? '#16A34A' : '#92400E';
            iconContainer.innerHTML = isTaken ? '<i class="fa-solid fa-check-circle"></i>' : '<i class="fa-solid fa-clock"></i>';
            modal.style.display = 'flex';
        }

        // SOS Emergency Functions
        function triggerSOSConfirm() {
            document.getElementById('sosModal').classList.add('active');
        }

        function cancelSOS() {
            document.getElementById('sosModal').classList.remove('active');
        }

        function confirmSOS() {
            const sosModal = document.getElementById('sosModal');
            const sosModalContent = sosModal.querySelector('.sos-modal-content');
            const confirmBtn = sosModal.querySelector('.sos-modal-btn.confirm');
            
            // Disable button and show loading state
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Sending...';
            
            fetch('/feature/sos/trigger', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' || data.success) {
                    // Show success message
                    sosModalContent.innerHTML = `
                        <div class="sos-modal-icon" style="animation: none;">
                            <i class="fa-solid fa-check-circle" style="color: #10B981;"></i>
                        </div>
                        <div class="sos-modal-title" style="color: #10B981;">SOS ACTIVATED!</div>
                        <div class="sos-modal-text">
                            <p>Your emergency alert has been sent to your guardian.</p>
                            <p>They will receive immediate notification and can track your location.</p>
                        </div>
                        <button onclick="closeSOS()" class="sos-modal-btn confirm" style="background: #10B981;">
                            <i class="fa-solid fa-check"></i> OK
                        </button>
                    `;
                } else {
                    throw new Error('SOS trigger failed');
                }
            })
            .catch(error => {
                console.error('SOS Error:', error);
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirm SOS';
                sosModalContent.innerHTML = `
                    <div class="sos-modal-icon" style="color: #E11D48;">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                    </div>
                    <div class="sos-modal-title">Error Sending SOS</div>
                    <div class="sos-modal-text">
                        <p>Failed to send emergency alert. Please try again or call emergency services directly.</p>
                    </div>
                    <div class="sos-modal-buttons">
                        <button onclick="closeSOS()" class="sos-modal-btn cancel">Close</button>
                        <button onclick="confirmSOS()" class="sos-modal-btn confirm">Retry</button>
                    </div>
                `;
            });
        }

        function closeSOS() {
            const sosModal = document.getElementById('sosModal');
            const sosModalContent = sosModal.querySelector('.sos-modal-content');
            
            // Reset modal content
            sosModalContent.innerHTML = `
                <div class="sos-modal-icon">
                    <i class="fa-solid fa-alarm"></i>
                </div>
                <div class="sos-modal-title">Emergency SOS Alert</div>
                <div class="sos-modal-text">
                    <p>Are you sure you want to send an emergency alert to your guardian?</p>
                    <p style="font-size: 0.85rem; color: #999; margin-top: 10px;">This action will immediately notify your guardian with your location.</p>
                </div>
                <div class="sos-modal-buttons">
                    <button onclick="cancelSOS()" class="sos-modal-btn cancel">Cancel</button>
                    <button onclick="confirmSOS()" class="sos-modal-btn confirm">Send SOS</button>
                </div>
            `;
            
            sosModal.classList.remove('active');
        }
    </script>

    <!-- Medication Reminder logic (adapted into patient dashboard) -->
    <script>
        document.addEventListener('DOMContentLoaded', initializeApp);

        let reminderInterval;
        let notificationPermissionGranted = false;
        let currentAlarm = null;
        let alarmAudioInterval = null;
        let alarmAudio = null;
        let currentTimePicker = {
            targetInput: null,
            hour: 8,
            minute: 0
        };

        function initializeApp() {
            updateTimeDisplay();
            setInterval(updateTimeDisplay, 1000);
            loadAllData();

            if (typeof Notification !== 'undefined' && Notification.permission === "granted") {
                notificationPermissionGranted = true;
            }

            requestNotificationPermission();
            startReminderCheck();
            updateSummary();
            updateUpcomingReminder();
        }

        function updateTimeDisplay() {
            const now = new Date();
            const timeElement = document.getElementById('currentTime');
            const dateElement = document.getElementById('currentDate');

            if (timeElement) {
                const timeString = now.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                });
                timeElement.textContent = timeString;
            }

            if (dateElement) {
                const dateString = now.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                dateElement.textContent = dateString;
            }
        }

        function requestNotificationPermission() {
            if (typeof Notification === 'undefined') {
                return;
            }

            const permissionRequested = localStorage.getItem('notificationPermissionRequested');

            if (Notification.permission === "default" && !permissionRequested) {
                Notification.requestPermission().then(permission => {
                    notificationPermissionGranted = (permission === "granted");
                    localStorage.setItem('notificationPermissionRequested', 'true');
                    if (notificationPermissionGranted) {
                        showNotification("Medication Reminder", "You will now receive medication reminders.");
                    }
                });
            } else if (Notification.permission === "granted") {
                notificationPermissionGranted = true;
            } else if (Notification.permission === "denied") {
                localStorage.setItem('notificationPermissionRequested', 'true');
            }
        }

        function startReminderCheck() {
            checkReminders();
            reminderInterval = setInterval(checkReminders, 5000);
        }

        function getCurrentTimeHHMM() {
            const now = new Date();
            return String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
        }

        function checkReminders() {
            if (currentAlarm && currentAlarm.snoozed && currentAlarm.snoozeUntil) {
                if (new Date() < currentAlarm.snoozeUntil) {
                    return;
                } else {
                    currentAlarm = null;
                }
            }

            if (currentAlarm && !currentAlarm.snoozed) {
                return;
            }

            const currentTime = getCurrentTimeHHMM();
            const data = getStoredData();
            if (!data) return;

            const allDoses = [
                ...(data.morning || []),
                ...(data.afternoon || []),
                ...(data.evening || [])
            ];

            allDoses.forEach(dose => {
                const doseTime = (dose.time || '').trim();
                if (!doseTime) return;
                const [dh, dm] = doseTime.split(':').map(n => parseInt(n, 10) || 0);
                const doseTimeNorm = String(dh).padStart(2, '0') + ':' + String(dm).padStart(2, '0');
                if (doseTimeNorm === currentTime && !dose.taken && !dose.notified) {
                    if (currentAlarm && currentAlarm.name === dose.name) {
                        return;
                    }

                    const patientName = data.patientName || 'Patient';
                    const medicationInfo = {
                        name: dose.name || 'Medication',
                        dosage: dose.dosage || '',
                        notes: dose.notes || '',
                        patientName: patientName
                    };

                    showVisibleAlarm(medicationInfo);

                    if (notificationPermissionGranted) {
                        const notificationTitle = `Medication Reminder for ${patientName}`;
                        const notificationBody =
                            `Time to take: ${dose.name}\nDosage: ${dose.dosage}${dose.notes ? '\nNote: ' + dose.notes : ''}`;
                        showNotification(notificationTitle, notificationBody);
                    }

                    dose.notified = true;
                    // Fix: Save directly to localStorage to avoid rewriting notified state via UI elements
                    localStorage.setItem('medicationReminderData', JSON.stringify(data));
                }
            });
        }

        function showVisibleAlarm(medicationInfo) {
            currentAlarm = {
                ...medicationInfo,
                snoozed: false,
                snoozeUntil: null
            };

            const alarmBanner = document.getElementById('alarmBanner');
            const alarmMessage = document.getElementById('alarmMessage');

            if (alarmBanner && alarmMessage) {
                let message = `It's time to take your medication!<br><br>`;
                message += `ðŸ’Š <strong>${medicationInfo.name}</strong><br>`;
                if (medicationInfo.dosage) {
                    message += `ðŸ“ Dosage: ${medicationInfo.dosage}<br>`;
                }
                if (medicationInfo.notes) {
                    message += `ðŸ“ Note: ${medicationInfo.notes}`;
                }

                alarmMessage.innerHTML = message;
                alarmBanner.classList.remove('hidden');
                alarmBanner.classList.add('flashing');
                document.body.classList.add('alarm-active');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                startAlarmSound();
            }
        }

        function startAlarmSound() {
            stopAlarmSound();
            playAlarmSound();
            alarmAudioInterval = setInterval(() => {
                playAlarmSound();
            }, 3000);
        }

        function stopAlarmSound() {
            if (alarmAudioInterval) {
                clearInterval(alarmAudioInterval);
                alarmAudioInterval = null;
            }
            if (alarmAudio) {
                alarmAudio.pause();
                alarmAudio.currentTime = 0;
                alarmAudio = null;
            }
        }

        function dismissAlarm() {
            const alarmBanner = document.getElementById('alarmBanner');
            if (alarmBanner) {
                alarmBanner.classList.add('hidden');
                alarmBanner.classList.remove('flashing');
            }
            document.body.classList.remove('alarm-active');
            stopAlarmSound();

            if (currentAlarm && currentAlarm.name) {
                markMedicationAsTakenInData(currentAlarm.name);
            }
            currentAlarm = null;
        }

        function markMedicationAsTakenInData(medicationName) {
            const data = getStoredData();
            if (!data) return;

            let found = false;
            ['morning', 'afternoon', 'evening'].forEach(section => {
                if (data[section]) {
                    data[section].forEach(med => {
                        if (med.name === medicationName && !med.taken) {
                            med.taken = true;
                            med.notified = true;
                            found = true;
                        }
                    });
                }
            });

                if (found) {
                    localStorage.setItem('medicationReminderData', JSON.stringify(data));
                    updateMedicationCheckboxInUI(medicationName, true);
                    updateSummary();
                    updateUpcomingReminder();
                }
            }

        function updateUpcomingReminder() {
            const el = document.getElementById('upcomingReminderContent');
            if (!el) return;
            const data = getStoredData();
            const allMeds = data ? [...(data.morning || []), ...(data.afternoon || []), ...(data.evening || [])] : [];
            const pending = allMeds.filter(m => m.time && !m.taken);
            if (pending.length === 0) {
                el.innerHTML = '<p style="margin:0; opacity:0.95;">No upcoming doses. Add medicines in the Smart Medication Reminder below.</p>';
                return;
            }
            const now = new Date();
            const candidates = pending.map(m => {
                const [h, min] = (m.time || '00:00').split(':').map(Number);
                const t = new Date();
                t.setHours(h || 0, min || 0, 0, 0);
                return { med: m, at: t };
            }).filter(x => x.at.getTime() >= now.getTime()).sort((a, b) => a.at - b.at);
            if (candidates.length === 0) {
                el.innerHTML = '<p style="margin:0; opacity:0.95;">All doses for today are done. Use "New day reset" tomorrow.</p>';
                return;
            }
            const next = candidates[0];
            const time12 = next.med.time ? (() => {
                const [h, m] = next.med.time.split(':').map(Number);
                const period = h >= 12 ? 'PM' : 'AM';
                const h12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
                return `${h12}:${String(m || 0).padStart(2,'0')} ${period}`;
            })() : next.med.time;
            el.innerHTML = `<p style="margin:0 0 8px 0; font-weight:700; font-size:1.2rem;">${next.med.name || 'Medication'}</p><p style="margin:0; opacity:0.9;">â° ${time12}</p>${next.med.dosage ? `<p style="margin:4px 0 0 0; font-size:0.9rem; opacity:0.85;">${next.med.dosage}</p>` : ''}`;
        }

        function updateMedicationCheckboxInUI(medicationName, checked) {
            const allMedItems = document.querySelectorAll('.med-item');
            allMedItems.forEach(item => {
                const nameInput = item.querySelector('.med-name');
                if (nameInput && nameInput.value === medicationName) {
                    const checkbox = item.querySelector('.med-taken');
                    if (checkbox) {
                        checkbox.checked = checked;
                        if (checked) {
                            item.classList.add('taken');
                        } else {
                            item.classList.remove('taken');
                        }
                    }
                }
            });
        }

        function snoozeAlarm() {
            if (!currentAlarm) return;

            const alarmBanner = document.getElementById('alarmBanner');
            if (alarmBanner) {
                alarmBanner.classList.add('hidden');
                alarmBanner.classList.remove('flashing');
            }
            document.body.classList.remove('alarm-active');
            stopAlarmSound();

            currentAlarm.snoozed = true;
            currentAlarm.snoozeUntil = new Date(Date.now() + 5 * 60 * 1000);

            setTimeout(() => {
                if (currentAlarm && currentAlarm.snoozed) {
                    currentAlarm.snoozed = false;
                    showVisibleAlarm(currentAlarm);
                }
            }, 5 * 60 * 1000);

            alert("Alarm snoozed for 5 minutes. You will be reminded again soon.");
        }

        function playAlarmSound() {
            try {
                if (alarmAudio) {
                    alarmAudio.pause();
                    alarmAudio.currentTime = 0;
                }
                alarmAudio = new Audio('/static/alarm.mp3');
                alarmAudio.volume = 0.8;
                alarmAudio.play().catch(e => console.warn("Alarm sound not available:", e));
            } catch (error) {
                console.warn("Alarm sound not available:", error);
            }
        }

        function showNotification(title, body) {
            if (typeof Notification === 'undefined') return;
            if (Notification.permission !== "granted") return;

            const options = {
                body,
                icon: 'https://cdn-icons-png.flaticon.com/512/3004/3004458.png',
                tag: 'medication-reminder',
                requireInteraction: true,
                vibrate: [200, 100, 200]
            };
            try {
                new Notification(title, options);
            } catch (error) {
                console.error("Notification error:", error);
            }
        }

        function updateAddButtons() {
            ['morning', 'afternoon', 'evening'].forEach(slot => {
                const list = document.getElementById(slot + 'List');
                const btn = document.querySelector('.med-add-' + slot);
                if (list && btn) {
                    btn.style.display = list.querySelectorAll('.med-item').length >= 1 ? 'none' : '';
                }
            });
        }

        function addMedication(timeOfDay) {
            const listContainer = document.getElementById(timeOfDay + 'List');
            if (!listContainer) return;
            if (listContainer.querySelectorAll('.med-item').length >= 1) return;

            const medId = Date.now() + Math.random();
            const medItem = document.createElement('div');
            medItem.className = 'med-item';
            medItem.id = 'med-' + medId;

            medItem.innerHTML = `
                <div class="med-item-row">
                    <label>Time</label>
                    <button type="button" class="time-input-btn" onclick="openTimePicker(this, '08:00')">
                        <span class="time-display-text">08:00</span>
                        <span>ðŸ•</span>
                    </button>
                    <input type="hidden" class="med-time" value="08:00">
                </div>
                <div class="med-item-row">
                    <label>Medicine</label>
                    <input type="text" class="med-name" placeholder="Medication name">
                </div>
                <div class="med-item-row">
                    <label>Dosage</label>
                    <input type="text" class="med-dosage" placeholder="e.g., 1 pill">
                </div>
                <div class="med-item-row">
                    <label>Notes</label>
                    <input type="text" class="med-notes" placeholder="e.g., with food">
                </div>
                <div class="taken-checkbox-container">
                    <input type="checkbox" class="taken-checkbox med-taken" id="taken-${medId}" onchange="markAsTaken(this); saveAllData(false);">
                    <label for="taken-${medId}">I have taken this medication</label>
                </div>
                <button class="delete-btn" onclick="deleteMedication('${medId}')">Remove</button>
            `;

            listContainer.appendChild(medItem);
            saveAllData(false);
            updateSummary();
            updateAddButtons();
        }

        function deleteMedication(medId) {
            if (!confirm("Remove this medication from your schedule?")) return;
            const medItem = document.getElementById('med-' + medId);
            if (medItem) {
                medItem.remove();
                saveAllData(false);
                updateSummary();
                showDeleteConfirmation();
                updateAddButtons();
            }
        }

        function showDeleteConfirmation() {
            const confirmation = document.getElementById('deleteConfirmation');
            if (confirmation) {
                confirmation.classList.remove('hidden');
                setTimeout(() => {
                    confirmation.classList.add('hidden');
                }, 2500);
            }
        }

        function markAsTaken(checkbox) {
            const medItem = checkbox.closest('.med-item');
            if (checkbox.checked) {
                medItem.classList.add('taken');
                if (currentAlarm) {
                    const nameInput = medItem.querySelector('.med-name');
                    if (nameInput && nameInput.value === currentAlarm.name) {
                        dismissAlarm();
                    }
                }
            } else {
                medItem.classList.remove('taken');
            }
            updateSummary();
        }

        function saveAllData(showToast = true) {
            const data = {
                patientName: document.getElementById('mrPatientName')?.value || '',
                morning: getSectionData('morningList'),
                afternoon: getSectionData('afternoonList'),
                evening: getSectionData('eveningList')
            };

            localStorage.setItem('medicationReminderData', JSON.stringify(data));
            updateSummary();
            updateUpcomingReminder();
            if (showToast) {
                showSaveConfirmation();
            }
        }

        function showSaveConfirmation() {
            const confirmation = document.getElementById('saveConfirmation');
            if (confirmation) {
                confirmation.classList.remove('hidden');
                setTimeout(() => {
                    confirmation.classList.add('hidden');
                }, 2500);
            }
        }

        function getSectionData(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return [];

            const storedData = getStoredData();
            const sectionName = sectionId.replace('List', '');
            const currentSectionData = storedData && storedData[sectionName] ? storedData[sectionName] : [];

            const medItems = section.querySelectorAll('.med-item');
            const sectionData = [];

            medItems.forEach(item => {
                const timeInput = item.querySelector('.med-time');
                const nameInput = item.querySelector('.med-name');
                const dosageInput = item.querySelector('.med-dosage');
                const notesInput = item.querySelector('.med-notes');
                const takenCheckbox = item.querySelector('.med-taken');

                const time = timeInput ? timeInput.value : '';
                const name = nameInput ? nameInput.value : '';

                let notified = false;
                if (name && time) {
                    const matchingMed = currentSectionData.find(med => med.name === name && med.time === time);
                    if (matchingMed) {
                        notified = matchingMed.notified || false;
                    }
                }

                sectionData.push({
                    time,
                    name,
                    dosage: dosageInput ? dosageInput.value : '',
                    notes: notesInput ? notesInput.value : '',
                    taken: takenCheckbox ? takenCheckbox.checked : false,
                    notified: notified
                });
            });
            return sectionData;
        }

        function loadAllData() {
            const storedData = localStorage.getItem('medicationReminderData');
            if (!storedData) {
                ['morningList', 'afternoonList', 'eveningList'].forEach(showEmptyState);
                updateUpcomingReminder();
                updateAddButtons();
                return;
            }

            const data = JSON.parse(storedData);
            const nameInput = document.getElementById('mrPatientName');
            if (nameInput) {
                nameInput.value = data.patientName || '';
            }

            const eveningMeds = [...(data.evening || []), ...(data.bedtime || [])];
            loadSectionData('morningList', data.morning || []);
            loadSectionData('afternoonList', data.afternoon || []);
            loadSectionData('eveningList', eveningMeds);
            updateSummary();
            updateUpcomingReminder();
            updateAddButtons();
        }

        function loadSectionData(sectionId, data) {
            const section = document.getElementById(sectionId);
            if (!section) return;

            section.innerHTML = '';
            const items = (data || []).slice(0, 1);
            if (items.length === 0) {
                showEmptyState(sectionId);
                return;
            }

            items.forEach((item, index) => {
                const medId = Date.now() + index;
                const medItem = document.createElement('div');
                medItem.className = 'med-item';
                if (item.taken) {
                    medItem.classList.add('taken');
                }
                medItem.id = 'med-' + medId;

                const timeValue = item.time || '08:00';
                const esc = (t) => {
                    const div = document.createElement('div');
                    div.textContent = t || '';
                    return div.innerHTML;
                };

                medItem.innerHTML = `
                    <div class="med-item-row">
                        <label>Time</label>
                        <button type="button" class="time-input-btn" onclick="openTimePicker(this, '${timeValue}')">
                            <span class="time-display-text">${timeValue}</span>
                            <span>ðŸ•</span>
                        </button>
                        <input type="hidden" class="med-time" value="${timeValue}">
                    </div>
                    <div class="med-item-row">
                        <label>Medicine</label>
                        <input type="text" class="med-name" value="${esc(item.name)}" placeholder="Medication name">
                    </div>
                    <div class="med-item-row">
                        <label>Dosage</label>
                        <input type="text" class="med-dosage" value="${esc(item.dosage)}" placeholder="e.g., 1 pill">
                    </div>
                    <div class="med-item-row">
                        <label>Notes</label>
                        <input type="text" class="med-notes" value="${esc(item.notes)}" placeholder="e.g., with food">
                    </div>
                    <div class="taken-checkbox-container">
                        <input type="checkbox" class="taken-checkbox med-taken" id="taken-${medId}" ${item.taken ? 'checked' : ''} onchange="markAsTaken(this); saveAllData(false);">
                        <label for="taken-${medId}">I have taken this medication</label>
                    </div>
                    <button class="delete-btn" onclick="deleteMedication('${medId}')">Remove</button>
                `;

                section.appendChild(medItem);
            });
        }

        function showEmptyState(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            const labels = {
                morningList: 'morning',
                afternoonList: 'afternoon',
                eveningList: 'evening'
            };
            section.innerHTML =
                `<div style="text-align:center; padding:14px; color:#64748b; font-size:0.9rem;">No ${labels[sectionId] || ''} medicines added yet. Use "Add medication" to get started.</div>`;
        }

        function updateSummary() {
            const data = getStoredData();
            if (!data) {
                document.getElementById('totalMeds').textContent = '0';
                document.getElementById('takenMeds').textContent = '0';
                document.getElementById('pendingMeds').textContent = '0';
                const nextElEmpty = document.getElementById('nextDoseText');
                if (nextElEmpty) {
                    nextElEmpty.textContent = 'No medicines scheduled in your reminder.';
                }
                updateUpcomingReminder();
                return;
            }

            const allMeds = [
                ...(data.morning || []),
                ...(data.afternoon || []),
                ...(data.evening || [])
            ];

            const total = allMeds.length;
            const taken = allMeds.filter(m => m.taken).length;
            const pending = total - taken;

            document.getElementById('totalMeds').textContent = total;
            document.getElementById('takenMeds').textContent = taken;
            document.getElementById('pendingMeds').textContent = pending;

            // Compute and show the next upcoming dose
            const nextEl = document.getElementById('nextDoseText');
            if (nextEl) {
                // Clear previous highlight
                document.querySelectorAll('.med-item.next-dose').forEach(el => el.classList.remove('next-dose'));

                if (allMeds.length === 0) {
                    nextEl.textContent = 'No medicines scheduled in your reminder.';
                    return;
                }

                const now = new Date();
                const upcomingCandidates = allMeds
                    .filter(m => m.time && !m.taken)
                    .map(m => {
                        const [h, min] = (m.time || '00:00').split(':').map(Number);
                        const t = new Date();
                        t.setHours(h || 0, min || 0, 0, 0);
                        return { med: m, at: t };
                    })
                    .filter(x => x.at.getTime() >= now.getTime())
                    .sort((a, b) => a.at - b.at);

                if (upcomingCandidates.length === 0) {
                    nextEl.textContent = 'All scheduled doses for today are past or marked as taken.';
                    return;
                }

                const next = upcomingCandidates[0];
                nextEl.textContent = `Next dose: ${next.med.name || 'Medication'} at ${next.med.time}`;

                // Visually highlight the matching card
                const items = document.querySelectorAll('.med-item');
                for (const item of items) {
                    const nameInput = item.querySelector('.med-name');
                    const timeInput = item.querySelector('.med-time');
                    if (nameInput && timeInput &&
                        nameInput.value === (next.med.name || '') &&
                        timeInput.value === (next.med.time || '')) {
                        item.classList.add('next-dose');
                        break;
                    }
                }
            }
            updateUpcomingReminder();
        }

        function getStoredData() {
            const storedData = localStorage.getItem('medicationReminderData');
            return storedData ? JSON.parse(storedData) : null;
        }

        // Seed reminder schedule from backend medications on first load
        function seedReminderFromBackend(meds) {
            if (!Array.isArray(meds) || meds.length === 0) return;

            const existing = getStoredData();
            const hasExisting =
                existing &&
                ((existing.morning && existing.morning.length) ||
                 (existing.afternoon && existing.afternoon.length) ||
                 (existing.evening && existing.evening.length));

            // Do not overwrite a schedule the patient has already configured
            if (hasExisting) return;

            const schedule = {
                patientName: existing?.patientName || '',
                morning: [],
                afternoon: [],
                evening: []
            };

            const timeDefaults = {
                morning: '08:00',
                noon: '12:00',
                afternoon: '13:00',
                evening: '18:00',
                night: '21:00'
            };

            meds.forEach(m => {
                const label = (m.time_of_day || '').toLowerCase();
                let slot = 'morning';
                if (label.includes('noon')) slot = 'noon';
                else if (label.includes('afternoon')) slot = 'afternoon';
                else if (label.includes('evening') || label.includes('night') || label.includes('bed')) slot = 'evening';

                const time = timeDefaults[slot] || '08:00';
                const entry = {
                    time,
                    name: m.name || 'Medication',
                    dosage: m.dosage || '',
                    notes: m.time_of_day || '',
                    taken: false,
                    notified: false
                };

                if (slot === 'noon') {
                    schedule.afternoon.push(entry);
                } else {
                    schedule[slot].push(entry);
                }
            });

            localStorage.setItem('medicationReminderData', JSON.stringify(schedule));
            loadAllData();
        }

        function resetDailyCheckmarks() {
            if (!confirm('Reset all checkmarks for a new day?')) return;

            const checkboxes = document.querySelectorAll('.med-taken');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                const medItem = checkbox.closest('.med-item');
                if (medItem) medItem.classList.remove('taken');
            });

            const data = getStoredData();
            if (data) {
                ['morning', 'afternoon', 'evening'].forEach(section => {
                    if (data[section]) {
                        data[section].forEach(med => {
                            med.taken = false;
                            med.notified = false;
                        });
                    }
                });
                localStorage.setItem('medicationReminderData', JSON.stringify(data));
            }

            updateSummary();
            alert('All medication checkmarks have been reset for today.');
        }

        function testReminder() {
            const testMedication = {
                name: "Test medication",
                dosage: "1 pill",
                notes: "This is only a test",
                patientName: document.getElementById('mrPatientName')?.value || 'Patient'
            };

            showVisibleAlarm(testMedication);

            if (typeof Notification !== 'undefined' && Notification.permission === "granted") {
                showNotification("Test Reminder", "This is a test notification to confirm reminders are working.");
            }

            setTimeout(() => {
                if (currentAlarm && currentAlarm.name === "Test medication") {
                    dismissAlarm();
                }
            }, 10000);
        }

        function openTimePicker(button, currentTime) {
            const parts = currentTime.split(':');
            const hour = parseInt(parts[0] || '8', 10);
            const minute = parseInt(parts[1] || '0', 10);

            const medItem = button.closest('.med-item');
            const hiddenInput = medItem.querySelector('.med-time');

            currentTimePicker = {
                targetButton: button,
                targetInput: hiddenInput,
                hour,
                minute
            };

            updateTimePickerDisplay();
            const modal = document.getElementById('timePickerModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeTimePicker() {
            const modal = document.getElementById('timePickerModal');
            if (modal) {
                modal.classList.add('hidden');
            }
            currentTimePicker = {
                targetInput: null,
                hour: 8,
                minute: 0
            };
        }

        function adjustTime(type, amount) {
            if (type === 'hour') {
                currentTimePicker.hour = (currentTimePicker.hour + amount + 24) % 24;
            } else if (type === 'minute') {
                currentTimePicker.minute += amount;
                while (currentTimePicker.minute < 0) {
                    currentTimePicker.minute += 60;
                    currentTimePicker.hour = (currentTimePicker.hour - 1 + 24) % 24;
                }
                while (currentTimePicker.minute >= 60) {
                    currentTimePicker.minute -= 60;
                    currentTimePicker.hour = (currentTimePicker.hour + 1) % 24;
                }
            }
            updateTimePickerDisplay();
        }

        function setPresetTime(time) {
            const parts = time.split(':');
            currentTimePicker.hour = parseInt(parts[0] || '8', 10);
            currentTimePicker.minute = parseInt(parts[1] || '0', 10);
            updateTimePickerDisplay();
        }

        function updateTimePickerDisplay() {
            const hourStr = String(currentTimePicker.hour).padStart(2, '0');
            const minuteStr = String(currentTimePicker.minute).padStart(2, '0');
            const timeStr = `${hourStr}:${minuteStr}`;

            let hour12 = currentTimePicker.hour;
            const period = hour12 >= 12 ? 'PM' : 'AM';
            if (hour12 === 0) hour12 = 12;
            else if (hour12 > 12) hour12 -= 12;
            const timeStr12h = `${hour12}:${minuteStr} ${period}`;

            const timeDisplay = document.getElementById('timeDisplayLarge');
            if (timeDisplay) timeDisplay.textContent = timeStr;

            const timeDisplay12h = document.getElementById('timeDisplay12h');
            if (timeDisplay12h) timeDisplay12h.textContent = timeStr12h;

            const hourValue = document.getElementById('hourValue');
            const minuteValue = document.getElementById('minuteValue');
            if (hourValue) hourValue.textContent = hourStr;
            if (minuteValue) minuteValue.textContent = minuteStr;
        }

        function confirmTimeSelection() {
            if (!currentTimePicker.targetInput || !currentTimePicker.targetButton) {
                closeTimePicker();
                return;
            }

            const hourStr = String(currentTimePicker.hour).padStart(2, '0');
            const minuteStr = String(currentTimePicker.minute).padStart(2, '0');
            const timeStr = `${hourStr}:${minuteStr}`;

            currentTimePicker.targetInput.value = timeStr;
            const displayText = currentTimePicker.targetButton.querySelector('.time-display-text');
            if (displayText) {
                displayText.textContent = timeStr;
            }

            saveAllData(false);
            closeTimePicker();
        }
    </script>

    <!-- SOS Modal -->
    <div id="sosModal" class="sos-modal">
        <div class="sos-modal-content">
            <div class="sos-modal-icon">
                <i class="fa-solid fa-alarm"></i>
            </div>
            <div class="sos-modal-title">Emergency SOS Alert</div>
            <div class="sos-modal-text">
                <p>Are you sure you want to send an emergency alert to your guardian?</p>
                <p style="font-size: 0.85rem; color: #999; margin-top: 10px;">This action will immediately notify your guardian with your location.</p>
            </div>
            <div class="sos-modal-buttons">
                <button onclick="cancelSOS()" class="sos-modal-btn cancel">Cancel</button>
                <button onclick="confirmSOS()" class="sos-modal-btn confirm">Send SOS</button>
            </div>
        </div>
    </div>

    <div id="refill-modal"
        style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.6); align-items:center; justify-content:center;">
        <div
            style="background:white; padding:40px; border-radius:20px; text-align:center; max-width:450px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <div
                style="background:#e8f5e9; width:70px; height:70px; border-radius:15px; display:flex; align-items:center; justify-content:center; margin: 0 auto 20px;">
                <i class="fa-solid fa-prescription-bottle-medical" style="font-size: 30px; color: #5b7c5b;"></i>
            </div>

            <h2 style="color:#333; margin-bottom:10px;">Refill Requested</h2>
            <p style="color:#666; margin-bottom:25px;">Your request for a medication refill has been sent to your
                guardian.</p>

            <button onclick="document.getElementById('refill-modal').style.display='none'"
                style="background:#5b7c5b; color:white; border:none; padding:15px; border-radius:10px; cursor:pointer; width:100%; font-weight:bold; font-size:16px;">
                I Understand
            </button>
        </div>
    </div>
</body>

</html>